<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptCode Webview Test Harness</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline' 'unsafe-eval'; img-src data:;">
    
    <!-- Load the actual webview styles -->
    <link rel="stylesheet" href="../../out/webview/styles/index.css">
    
    <script>
        // Mock the VS Code API that the webview expects
        const vscode = (() => {
            const state = {};
            const messageHandlers = [];
            
            return {
                postMessage: (message) => {
                    console.log('Message to extension:', message);
                    
                    // Simulate some responses for testing
                    setTimeout(() => {
                        switch(message.command) {
                            case 'getSelectedFiles':
                                window.postMessage({
                                    command: 'updateSelectedFiles',
                                    files: []
                                }, '*');
                                break;
                            case 'getTokenCounts':
                                window.postMessage({
                                    command: 'updateTokenCounts',
                                    tokenCounts: {}
                                }, '*');
                                break;
                        }
                    }, 10);
                },
                setState: (newState) => {
                    Object.assign(state, newState);
                },
                getState: () => state
            };
        })();
        
        // Make it available globally as the webview expects
        window.acquireVsCodeApi = () => vscode;
        
        // Set up the script loaded flags that the webview checks
        window._scriptLoaded = {
            selectFilesTab: false,
            instructionsTab: false,
            generatePromptTab: false,
            mergeTab: false,
            webview: false
        };
    </script>
</head>
<body>
    <div class="container">
        <!-- Tab navigation structure matching the real webview -->
        <div class="tab-triggers">
            <button class="tab-trigger active" data-tab="selectFiles">
                <span class="tab-icon">üìÅ</span>
                <span class="tab-label">Select Files</span>
            </button>
            <button class="tab-trigger" data-tab="instructions">
                <span class="tab-icon">üìù</span>
                <span class="tab-label">Instructions</span>
            </button>
            <button class="tab-trigger" data-tab="generate">
                <span class="tab-icon">üöÄ</span>
                <span class="tab-label">Generate Prompt</span>
            </button>
            <button class="tab-trigger" data-tab="apply">
                <span class="tab-icon">üîß</span>
                <span class="tab-label">Apply & Review</span>
            </button>
        </div>

        <!-- Tab content containers matching the real webview structure -->
        <div class="tab-content active" id="selectFilesTab">
            <div class="file-selector-container">
                <div class="file-selector-header">
                    <h3>Selected Files</h3>
                    <div class="file-selector-actions">
                        <button id="selectAllBtn">Select All</button>
                        <button id="deselectAllBtn">Deselect All</button>
                    </div>
                </div>
                
                <div id="selected-files-list">
                    <!-- This will be populated by the webview code -->
                </div>
                
                <div id="file-tree-container">
                    <!-- File tree would go here -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="instructionsTab">
            <div class="instructions-container">
                <h3>Instructions</h3>
                <div id="instructions-content">
                    <!-- Instructions content -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="generateTab">
            <div class="generate-container">
                <h3>Generate Prompt</h3>
                <div id="generate-content">
                    <!-- Generate content -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="applyTab">
            <div class="apply-container">
                <h3>Apply & Review</h3>
                <div id="apply-content">
                    <!-- Apply content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Load the actual compiled webview scripts -->
    <script src="../../out/webview/selectFilesTab.js"></script>
    <script src="../../out/webview/instructionsTab.js"></script>
    <script src="../../out/webview/generatePromptTab.js"></script>
    <script src="../../out/webview/mergeTab.js"></script>
    <script src="../../out/webview/webview.js"></script>
    
    <script>
        // Initialize the webview after scripts are loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Trigger any initialization that the webview expects
            if (typeof initializeWebview === 'function') {
                initializeWebview();
            }
            
            // Set up test data for the Select Files tab
            const testFiles = [
                {
                    directory: 'test/',
                    files: [
                        { name: 'file1.ts', path: '/test/file1.ts', tokens: 1500, percentage: 60 },
                        { name: 'file2.ts', path: '/test/file2.ts', tokens: 800, percentage: 32 }
                    ]
                },
                {
                    directory: 'src/',
                    files: [
                        { name: 'main.ts', path: '/src/main.ts', tokens: 200, percentage: 8 }
                    ]
                }
            ];
            
            // Populate the selected files list with test data
            const filesList = document.getElementById('selected-files-list');
            if (filesList) {
                testFiles.forEach(group => {
                    // Add directory header
                    const header = document.createElement('div');
                    header.className = 'directory-header';
                    header.innerHTML = `
                        <span class="directory-name">${group.directory}</span>
                        <button class="trash-btn" title="Remove directory">üóëÔ∏è</button>
                    `;
                    filesList.appendChild(header);
                    
                    // Add files
                    group.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'selected-file-item';
                        fileItem.innerHTML = `
                            <span class="file-name">${file.name}</span>
                            <span class="token-count">${(file.tokens/1000).toFixed(2)}k tokens (${file.percentage.toFixed(1)}%)</span>
                        `;
                        filesList.appendChild(fileItem);
                    });
                });
                
                // Make trash buttons functional for testing
                filesList.addEventListener('click', (e) => {
                    if (e.target.classList.contains('trash-btn')) {
                        const header = e.target.closest('.directory-header');
                        if (header) {
                            // Remove the header and its files
                            let next = header.nextElementSibling;
                            while (next && !next.classList.contains('directory-header')) {
                                const toRemove = next;
                                next = next.nextElementSibling;
                                toRemove.remove();
                            }
                            header.remove();
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>